\documentclass {book} 
\usepackage [spanish] {babel} 
%\usepackage [T1]{fontenc}
\usepackage [latin1]{inputenc}
\usepackage{graphicx}
\begin{document} 





\title{Aplicacion BetFair para iPhone}
\author{Francisco Miguel Merchan Casado}
\date{Abril de 2009}                                           % Activate to display a given date or no date


\begin{titlepage}
\begin{center}
	{\Large UNIVERSIDAD POLITÉCNICA DE MADRID}\\[2cm]
	{\Large FACULTAD DE INFORMÁTICA}\\ [4cm]
	{\Large Trabajo de Fin de Carrera}\\[1cm]
	
	{\Huge Aplicación de apuestas para iPhone 3G}\\[8cm]
	
	{\Large AUTOR: Francisco Miguel Merchán Casado}\\
	{\Large TUTOR: Ángel Herranz Nieva}\\
\date{Abril de 2009}
\end{center}
\end{titlepage}

%{\Large Indice de contenidos}\\
\tableofcontents
\newpage
%\maketitle

\chapter{Resumen}
En este documento se describe el trabajo de fin de carrera acerca del desarrollo de una aplicación de apuestas de BetFair para el dispositivo iPhone. Esta aplicación contiene las siguientes funcionalidades:
\begin{itemize}
    \item Consultar los eventos de BetFair por los que se puede apostar
    \item Apostar en los eventos.
    \item Realizar seguimientos a la evolución de los mercados.
    \item Asesoramiento para realizar Tradings sobre apuestas ya realizadas.
  \end{itemize}
    
    A continuación se explica con más detalle la realización del trabajo.
  
\chapter{Introducción}

\section{Mundo de las apuestas y BetFair}

Actualmente las apuestas deportivas por internet tienen gran aceptación en todo el mundo. En España ya hay una tradición de bastantes años por la quiniela y la lotería. Sin embargo, actualmente ya empiezan a estar desfasadas por poca capacidad de adaptarse a tiempos y gustos nuevos. En la quiniela, al tratarse de cantidades variables nunca sabemos por anticipado cuánto cobraremos en caso de acierto. Un acierto de 13 resultados puede convertirse en una gran decepcion por el premio consguido.

Con el gran desarrollo de internet surgen las casas de apuesta en linea como Bwin.com, BetFair y MiApuesta.com, por citar las más conocidas. Las casas de apuestas nos ofrecen una gran variedad de apuestas en diferentes deportes que nos permiten adecuarnos a nuestros gustos y conocimientos. Esto unido a la evolución de Internet, facilita el acceso a la información y el pago de las apuestas a través de transferencias electrónicas seguras.

****
 Para facilitar en entendimiento y la comprensión acerca de la temática de este trabajo de Fin de Carrera definiremos los principales conceptos en una apuesta:
 \begin{itemize}
 \item Bankroll: Es la cantidad de dinero (capital) que estamos dispuestos a apostar. Lógicamente tendremos que administrarlo de la mejor manera posible, minimizando las pérdidas en caso de perder una apuesta y maximizar las ganancias de una apuesta ganadora. La disciplina y el conocimiento del mercado son las mejores aliadas de nuestro Bankroll. La mayoría de las casas de apuesta por Internet nos regalan un mínimo Bankroll para animarnos a participar en ellas.
 \item Stake: Es la cantidad que ofrecemos en la apuesta por un determinado evento. Es decir, apostar 10? a que gana el Sevilla F.C el campeonato de liga de 2009.
 \item Odds: Es la cuota (probabilidad) de una apuesta. Por ejemplo se paga 3 que Fernando Alonso gane el mundial de F1
 \item Beneficio: Es la ganancia que obtenemos de una apuesta ganadora cuyo resultado es el siguiente:
				Beneficio = (stake x odd) - stake
 \item Pida: Lógicamente lo opuesta al beneficio. Lo que todo apostante quiere evitar. 
 \item Yield: Espresado en porcentaje expresa el beneficio obtenido del total apostado. Es lo que diferencia a un buen apostador de los demas. El cálculo es el siguiente:
			Yield = (Beneficio / Total apostado) x 100
 \end{itemize} 
*****

Un modalidad de apuesta derivada de la aparición de las casas de apuestas en Internet es el Trading.  Se trata de apostar en contra de tu ultima apuesta sobre un mismo evento obteniendo asi una ganancia segura en unos casos o minimizar la pérdida en otros. La primera casa de apuestas en ofrecer este servicio fue BetFair.com. Este método se suele dar en dos escenarios típicos:
\begin{itemize}
	\item Suceso sobrevalorado: apostamos por un evento con una cuota alta y según se va acercando al final del evento disminuye la misma.
	\item Suceso infravalorado: apostamos por un evento con una cuota baja y esta va subiendo según se va acercando el final de evento.
\end{itemize}

 La ventaja de realizar este tipo de apuestas es que en función de los resultados que hagamos podemos obtener beneficios pase lo que pase en el evento apostado.
 
En el siguiente ejemplo exponemos un caso típico de Trading para su mejor entendimiento:

\begin{figure} [h]
  \centering
    \includegraphics[width=1\textwidth]{./images/SampleTrading1.png}
  \caption{Situacion inicial}
  \label{fig:Inicio}
\end{figure}

 Tal y como observamos en la figura X, vemos que el favorito para la victoria del partido es Nadal. Su cuota a favor esta mucho más alta que la de Roger Federer. En el mundo de las apuestas, influyen todos los pequeños factores que al aficionado se les escapa. Supongamos que Nadal pierde el primer set, esto desemboca en cambios en la tabla de apuestas.
 
  
  Vemos ahora que el mercado ha cambiado. Ahora mismo se refleja una clara ventaja para la victoria del Roger Federer.
   
  \begin{figure} [h]
    \centering
       \includegraphics[width=1\textwidth]{./images/SampleTrading2.png}
     \caption{Situacion cambiante}
   \label{fig:Inicio}
\end{figure}

   En este ejemplo, al principio realizamos una apuesta a favor de Rafa Nadal por 50 euros, con lo que tendríamos:   	
	
	Beneficio = (1.8 x 50) - 50 =  40 euros si gana Rafa Nadal
	Riesgo = -50 euros si pierde Nadal
	
  Un tiempo más adelante, el mercado a cambiado debido al resultado del primer set, Nadal ya no es tan favorito para la victoria.
  
  Para asegurar el dinero apostado anteriormente realizamos una apuesta en contra de Nadal. De tal forma que nos queda:
  
  	Beneficio = 70 euros si pierde Nadal
	Riesgo = 70 - (1.2 x 70) = -14 euros si gana Nadal
	 
   Al final tenemos que:
   
    Si gana Rafa Nadal obtenemos : 40 euros - 14 = 26 euros de beneficio
    Si pierde Nadal y por tanto gana Roger Federer : 70 - 50 = 20 euros de beneficio
    
   Con lo que estamos cubierto ante cualquier resultado del partido. En ambos casos tenemos ganancias. El escenario expuesto es uno de los mejores casos que nos pueden dar ya que obtenemos beneficio en ambos casos. Pero puede suceder que hayamos apostado por un evento con demasiada confianza y luego en un futuro vemos que puede ser una ruina. En ese escenario el objetivo prioritario sería minimizar la pérdida apostando en contra del evento en cuestión.
   
\section{API de servicios de BetFair}

En el año 2007 BetFair es el primer portal de apuestas que ofrece un API de acceso a sus servicios. La estrategia es clara, enganchar a los desarrolladores para crear todo tipo de aplicaciones de apuestas usando su portal de apuestas como base. Como era de espera empezaron a salir multitud de aplicaciones dirigidas a un sector experto (para todos aquellos que se les queda corto el portal de internet) y aplicaciones para principiantes. Ahora, con las nuevas tecnologías móviles, el usuario quiere / necesita realizar consultas en todo momento de sus servicios contratados. Ya sea email, saldo de su cuenta del banco..... es la hora de las aplicaciones móviles.


\section{Apple y su SDK de desarrollo para iPhone}
 
Apple inició la revolución del ordenador personal en la década de los setenta con el ordenador Apple II y reinventó el ordenador personal en los ochenta con el Macintosh. Hoy, Apple sigue liderando la industria en innovación con sus premiados ordenadores de sobremesa y portátiles, el sistema operativo OS X, iLife (aplicación de creación de contenido multimedia) y sus aplicaciones profesionales. Apple está también en la vanguardia de la revolución musical con sus reproductores de música y vídeo portátiles iPod y la tienda de música online iTunes, e irrumpió en 2007 en el mercado de la telefonía móvil con su revolucionario iPhone.

\begin{figure} [h]
  \centering
    \includegraphics[width=0.6\textwidth]{./images/main_overview.jpg}
  \caption{IPhone 3G}
  \label{fig:iPhone 3G}
\end{figure}
  
 El iPhone muy pronto se convirtió en un fenómeno extraordinario. Horas antes de su salida al mercado ya había colas de espera de más de 8 horas, nunca antes visto en un lanzamiento de un móvil. Su gran pantalla unida a las más novedosas tecnologías del momento convirtieron al dispositivo en alcanzar el millón de ventas en EEUU. Pero no todo fueron buenas noticias para Apple. En Europa, donde no se vendía el dispositivo, criticaban el dispositivo por su apuesta en tecnología obsoleta en Europa, GPRS (acceso similiar al bando de ancha de un modem analógico) para aceder a las redes de datos de telefonía y su escaso soporte para crear contenido para el dispositivo.

  Por todo esto, en Marzo de 2008 Apple comunica su deseo de lanzar su tienda de aplicaciones para el iPhone para Julio del mismo año y lanza un conjunto de herramientas de desarrollo (SDK) para todos aquellos desarrolladores que quieran participar en la misma. 
  
 En Europa hubo que esperar hasta Julio de 2008, de la mano de Telefónica se lanza el iPhone 3G, una versión mejorada del iPhone con tecnología de acceso a red 3G. Con este avance el dispositivo se afianza como uno de los más rápidos para acceder a la red de redes,Internet, y hacer uso de los servicios web 2.0 (fotos, blogs, localización, voz por IP...).

  Hoy en día, se ha alcanzado el millón de descargas de aplicaciones en el iTunes App Store (Tienda de aplicaciones del iphone) confirmando el éxito del dispositivo.

  He aquí la importancia de la temática de este Trabajo de FIn de Carrera, la adaptación del API de Betfair a la plataforma iPhone y la creación de una aplicación para hacer uso de los servicios de esta casa de apuestas.
    
   
\chapter{Objetivos}

 Los objetivos que se prenteden cubrir con el actual trabajo de fin de carrera son los siguientes:
 \begin{itemize}
 	\item Posibilidad de apostar por eventos del portal BetFair.com usando su API de acceso a sus servicios web.
	\item Asesorar el usuario sobre cuando realizar el trading a las apuestas ya realizadas.
\end{itemize}

\chapter{Requisitos}
\section{Escenario}
El escenario que prentende cubrir la aplicación es la gestión de los eventos del portal de apuestas BetFair. Se pretende cubrir las mismas funcionalidades que ofrece BetFair en su portal web.
\section{Historias de Uso vs Caso de uso}
\section{Historias recopiladas}
\subsection{Instalación} Para poder instalar la aplicación solo se necesitará una cuenta del programa iTunes Store de Apple. Es gratuito. La aplicación estará disponible dentro del programa App Store del dispositivo. Solamente habrá que descargar la aplicación de dicho portal.
\subsection{Actualizar la aplicación}
La aplicación  App Store  del dispositivo será la encargada de comunicar al usuario la aparición de una nueva versión del aplicativo. Para actualizarla simplemente habrá que seguir las indicaciones de dicho programa.
\subsection{Desinstalar}
Para desinstalar la aplicación simplemente se mantiene pulsado el icono de la misma una segundos e inmediatamente pulsamos sobre la X que aparecerá sobre la misma.
\subsection{Ejecución}
Para lanzar la aplicación solo hay que pulsar el icono que aparece en la pantalla principal del dispositivo.
\subsection{Configurar la aplicación}
Para poder usar los servicios de BetFair a través de la aplicación hay que configurar los datos de acceso al servicio. Para ello, hay que pulsar sobre el icono de "Ajustes" del dispositivo. Una vez abierta la pantalla buscamos la celda que contiene el nombre de la aplicación e introducimos los datos de acceso al servicio web BetFair
\subsection{Gestión de los Eventos}
Se podrá navegar y obtener información de todos los eventos disponibles del portal BetFair.
\subsection{Realizar una apuesta}
Una vez lanzada la aplicación pulsamos sobre Eventos. Navegamos por los menús hasta llegar al evento de nuestro interés. Una vez en la pantalla de información del evento observamos las cuotas y cantidades del mercado e ntroducimos el tipo de apuesta, la cantidad y la cuota deseados. Seguidamente pulsamos sobre el botón Apostar y confirmamos la apuesta. El sistema nos mostrará si la apuesta se ha realizado con éxito.
\subsection{Gestionar las apuestas}
La aplicación será capaz de recopilar todas las apuestas realizadas sobre BetFair. Por cada apuesta el sistema mostrará· las opciones disponibles.
\subsection{Realizar Trading sobre una apuesta ya realizada}
El sistema será capaz de asesorar para realizar Trading sobre una apuesta ya realizada anteriormente. Para ello se mostrará una tabla con las opciones disponibles dentro del resumen de una apuesta ya realizada.

\chapter{Arquitectura}
En este capítulo se presentará la arquitectura de la aplicación. Para un mejor entendimiento de la misma explicaremos brevemente la arquitectura del dispositivo iPhone (Cocoa Touch). Seguiremos por una breve descripción del API de Betfair y terminaremos con una explicación detalla de la arquitectura desplegada en la aplicación.


\section{Descripción general}
 
  Como ya hemos visto en capítulos anteriores los requisitos de la aplicación dan como resultado la arquitectura actual de la aplicación. Para llevar a cabo su desarrollo, hemos tenido en cuenta la arquitectura del dispositivo y las herramientas adjuntas. Todas las decisiones tomadas en la construcción de la arquitectura de la aplicación se han basado en los límites o restricciones impuestas por el uso de la arquitectura de Apple y los límites impuestos en el uso del API de Betfair. Para comprender mejor la composición de la aplicación explicaremos brevemente la arquitectura impuesta por Apple en el iPhone y la tecnología en la que se basa el API que ofrece BetFair para el uso de sus servicios.

\section{Arquitectura del iPhone y su SDK}
 La Arquitectura del iphone se basa en su sistema operativo iPhone OS capaz de ejecutar tanto aplicaciones web como aplicaciones nativas. La arquitectura del iPhone OS es similar a la arquitectura básica encontrada en los Mac OS X (ordenadores personales de Apple). Esta decisión fue tomada por Apple para facilitar la transición de los programadores de Mac a la plataforma del iPhone. En una descripción de alto nivel, el iPhone OS es un mero intermediario entre el hardware del dispositivo y las aplicaciones que disponemos en el dispositivo. 

\begin{figure} [h]
  \centering
    \includegraphics[width=0.5\textwidth]{./images/overview_systemlayers.jpg}
  \caption{IPhoneOS system layers}
  \label{fig:iPhoneOS layers}
\end{figure}

 La implemetación de las tecnologías del iPhone OS se puede ver como un conjunto de capas. En la parte baja del sistema se encuentran las capas encargadas de los servicios fundamentales que permiten la ejecución de las aplicaciones, y en las más altas contienen las capas sobre los servicios multimedía y de las mñas latas tecnologías.

 \begin{itemize}
\item Capa Cocoa Touch:
  Es una de las capas más importantes del iPhone OS. Es la encargada de proveer la infraestructura necesaria para la implemetación de aplicaciones. Contiene los siguientes frameworks:

 \item UIKit FrameWork: Contiene todas las clases necesarias para la programación de la interfaz de usuario de las aplicaciones asi como el acceso a las principales tecnologías físicas propias del dispositivo  móvil (acelerómetro, camara ....)

 \item Foundation Framework: Es un framework heredado de la plataforma OS X. Provee el sosporte para las siguientes características:
 \begin{itemize}
	\item Colecciones de datos (arrays, sets....)
	\item Gestión del Tiempo y Fechas.
	\item Gestión de las preferencias del dispositivo.
	\item Gestión de URLs
	\item Internalizaciones del dispositivo.
\end{itemize}
\item Addres Book UI Framework: Una de las partes más importantes en un dispositivo móvil es la agenda de contactos del dispositivo. Este framework es el encargado de gestionar toda la interfaz de usuario relacionado con los contactos del dispositivo.

\item Capa Media:

Es la capa encargada de dar soporte a las tecnologías de gráficos, audio y video para proporcionar al usuario la mejor experiencia multimedia vista en un dispositivo móvil. Más importates que las tecnologías en si, esta capa fue diseñada para facilitar al desarrollador su uso para crear aplicaciones con una gran apariencia en su interfaz de usuario y una reproducción de audio genial. 

 A continuación enumeramos las tecnologiás soportadas:
\begin{itemize}
  \item Gráficos: Quartz, Quartz Core Animation, Open GL
  \item Sonidos: ACC, Apple Lossless, A-law, IMA4, Linear PCM, u-law
  \item Video: MPEG-4, H.264
\end{itemize}
\item Capa Core Services:
 La Core Services Layer es la encargada de proporcionar los servicios básicos del sistema a las aplicaciones para su uso. Contiene los siguientes frameworks:
\begin{itemize}
	\item AdressBook: Provee los servicios básicos para acceder a los contactos almacenados en el dispositivo.
	\item Core Foundation: Es un conjunto de interfaces para dar soporte de gestión de datos y servicios para el uso de las aplicaciones del dispositivo. 
	\item CF Network: Conjunto de interfaces para que las aplicaciones hagan uso de los protocolos de red implementados en el terminal. 
	\begin{itemize}
		\item BSD Sockets.
		\item Conexiones encriptadas
          	\item Resolución de nombres DNS
		\item HTTP, HTTPS
		\item Servicios Bonjour
		\end{itemize}
	\item Core Location: Framework que permite determinar la actual posición (latitud, longitud) del dispositivo. Hace uso del dispositivo GPS implementado en el dispositivo. Ofrece todo lo necesario para que las aplicaciones implementen características de localización o guiado.
	\item Security: Garantiza el acceso seguro a los datos y aplicaciones almacenadas en el dispositivo.
	\item SQLite: Soporte para gestionar bases de datos para que las aplicaciones gestionen sus datos.
	\item Soporte a XML: Soporte para dar a las aplicaciones métodos para manipular contenido XML.
\end{itemize}
\item Capa Core OS: 

	Es la capa que contiene el entorno del núcleo de sistema (kernel), controladores para dispositivos, interfaces básicas del sistema operativo. El kernel es el responsable de todos los aspectos relacionados con el sistema operativo. Es el encargado de gestionar la memoria virtual, threads (procesos ligeros), sistema de ficheros, red y procesos de comunicación. Los controladores son los encargados de proporcionar la interfaz entre el hardware y los frameworks de las capas superiores. 
\end{itemize}

\section{Arquitectura del API de BetFair}

	El API de Betfair esta diseñado bajo una interfaz SOAP que esta disponible a través de una conexión web segura. (Explicación de SOAP).

          El API esta disponible a partir de un fichero en formato WSDL. Dicho formato describe la interfaz para los servicios web SOAP. Contiene todas las llamadas a los procedimientos remotos de los servicios proporcionados por BetFair.  Los servicios proporcionados por el API se dividen en dos conjuntos: Global y Exchange. 

   El conjunto Global contiene todas las llamadas básicas referentes a los servicios de (login) a BetFair, la administración de tu cuenta BetFair, tus fondos y las llamadas para navegar por los diferentes eventos disponibles en el portal de apuestas.

   El conjunto Exchange contiene las llamadas a los servicios de apuestas, es decir, apostar por un evento, descripción de los mercados disponibles, actualización o cancelación de las apuestas ya realizadas, historial de todas nuestra apuestas.....

  Existen dos formas de acceso al API:
\begin{itemize}
		\item Free Access API: con este acceso tendremos disponibles los servicios básicos del portal. Las herramientas suficientes para poder apostar por los eventos disponibles. Gratuita pero con acceso limitado a las llamadas de los servicios.
		\item Full Access API: Acceso de pago donde están disponibles servicios exclusivos del portal tales como información avanzada de los mercados, gestión avanzada de nuestra cuenta de usuario.... Cuota anual y sin límites en las llamadas.
\end{itemize}
    Para nuestra aplicación, al no soportar los archivos WSDL,hubo que implementar cada llamada a los servicios de betfair bajo la tecnología Apple y su posterior serialización para el tratamiento de datos de la aplicación.

    Los servicios básicos que hemos usado para el desarrollo de la aplicación han sido:
\begin{itemize}
	\item GetActiveEventTypes: 
		Con esta llamada obtenemos todos los eventos deportivos actualmente en marcha por los que se puede apostar.
	\item GetAllMarkets:
		Con esta llamada obtenemos todos los mercados referentes a un evento.
	\item GetCurrentsBets:
		Llamada por la cual obtenemos todas las apuestas activas que hemos realizado.
	\item GetMarketPrices:
		Obtenemos los precios (back y lay) actuales por un evento determinado.
	\item GetMarket:
		Esta llamada nos devuelve todos los datos referentes a un mercado.
	\item PaceBets:
		Con esta llamada enviamos una apuesta a betfair.
\end{itemize}
\section{Arquitectura de la aplicación}
 Para el diseño de la arquitectura nos hemos basado en el patrón de diseño "Modelo Vista Controlador". La razón del uso de este patrón se ha debido a dos cuestiones funcdamentales:
\begin{itemize}
	\item La facilidad entre la comunicación entre el modelo de datos y la interfaz. Añadir también que cualquier cambio en la interfaz de usuario no afecta al resto del modelo, por lo que se gana en facilidad a la hora de seguir desarrollando la solución en el futuro.
	\item Apple, en el uso de las herramientas de desarrolla del SDK, te recomienda el uso de dicho patrón para la creación de la interfaz de usuario de la aplicación. Esta recomendación es debido a la arquitectura interna del iPhone OS visto en un capítulo anterior y a que sus herramientas de desarrollo también estan orientadas a esta solución.
\end{itemize}
\section{Diagrama de Clases}






 

\chapter{Implementación}

\section{Entorno de ejecución}
\section{Internalización}
\section{Interpretación XML de BetFair a Cocoa Touch}



\chapter{Conclusiones}


\end{document}  